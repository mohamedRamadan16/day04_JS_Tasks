<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>P01</title>
  </head>
  <body>
    <script>
      const products = [
        { id: 1, name: "Laptop", price: 30000, stock: 5 },
        { id: 2, name: "Phone", price: 15000, stock: 0 },
        { id: 3, name: "Headphone", price: 2000, stock: 10 },
        { id: 4, name: "Keyboard", price: 1000, stock: 3 },
      ];

      // use promises to do these requirments
      // 1- Get all products (simulate API) ... use promise + setTimeout to return products after 2 seconds
      function fetchProducts() {
        return new Promise((res, rej) => {
          setTimeout(() => {
            console.log("Fetching data ... ");
            res(products);
          }, 3000);
        });
      }

      let prom = fetchProducts().then((res) => {
        console.log(res);
        console.log("*************************************************");

        return res;
      });

      // 2- Filter available products (stock > 0) using then
      prom
        .then((res) => {
          return new Promise((resolve) => {
            resolve(res.filter((p) => p.stock > 0));
          });
        })
        .then((res) => {
          console.log(res);
          console.log("*************************************************");
        });

      // 3- Calculate total price
      prom
        .then((res) => {
          let sum = 0;
          res.forEach((p) => (sum += p.price));
          return sum;
        })
        .then((res) => {
          console.log(res);
          console.log("*************************************************");
          return res;
        })
        .then((res) => {
          return new Promise((resolve, reject) => {
            if (res > 5000) {
              products.forEach((p) => {
                p.price = 0.9 * p.price;
              });
              resolve("Done");
            } else {
              reject("total is less than 5000");
            }
          });
        })
        .then((res) => {
          console.log(res);
          console.log(products);
        })
        .catch((err) => {
          console.log(err.message);
        });

      // 4- Apply discount 10% ( reject if total < 5000 )
    </script>
  </body>
</html>
